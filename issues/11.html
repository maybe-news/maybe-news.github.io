<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Issue #11 | Maybe News</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://maybe.news/issues/11"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Issue #11 | Maybe News"><meta data-rh="true" name="description" content="本期关键词：Procella、PrestoDB@Facebook、Apache Arrow、S3 Consistency、Feast、Uptown Records"><meta data-rh="true" property="og:description" content="本期关键词：Procella、PrestoDB@Facebook、Apache Arrow、S3 Consistency、Feast、Uptown Records"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-07-08T13:10:00.000Z"><meta data-rh="true" property="article:tag" content="issue"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://maybe.news/issues/11"><link data-rh="true" rel="alternate" href="https://maybe.news/issues/11" hreflang="en"><link data-rh="true" rel="alternate" href="https://maybe.news/issues/11" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://maybe.news/issues/11","mainEntityOfPage":"https://maybe.news/issues/11","url":"https://maybe.news/issues/11","headline":"Issue #11","name":"Issue #11","description":"本期关键词：Procella、PrestoDB@Facebook、Apache Arrow、S3 Consistency、Feast、Uptown Records","datePublished":"2021-07-08T13:10:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://maybe.news/issues","name":"Issues"}}</script><link rel="alternate" type="application/rss+xml" href="/issues/rss.xml" title="Maybe News - Issues RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/issues/atom.xml" title="Maybe News - Issues Atom Feed">
<link rel="alternate" type="application/json" href="/issues/feed.json" title="Maybe News - Issues JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FS15RZL4X6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-FS15RZL4X6",{})</script>




<link rel="alternate" type="application/rss+xml" href="/series/rss.xml" title="Maybe News - Series RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/series/atom.xml" title="Maybe News - Series Atom Feed">
<link rel="alternate" type="application/json" href="/series/feed.json" title="Maybe News - Series JSON Feed">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i,900,900i|Nanum+Gothic+Coding:400,400i,700,700i,900,900i|Neuton:400,400i,700,700i,900,900i"><link rel="stylesheet" href="/assets/css/styles.307401c9.css">
<script src="/assets/js/runtime~main.7c42781f.js" defer="defer"></script>
<script src="/assets/js/main.76cd10d2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Maybe News</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/issues">Issues</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Series</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/series/tags/dail-up">连接：互联网简史</a></li></ul></div><a class="navbar__item navbar__link" href="/sponsor">Sponsor</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_brwN thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_r4Q1 margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_hiiw">2023</h3><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/issues/sp-1">SP #1</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_hiiw">2022</h3><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/issues/13">Issue #13</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/issues/sp-0">SP #0</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_hiiw">2021</h3><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/issues/12">Issue #12</a></li><li class="sidebarItem_lnhn"><a aria-current="page" class="sidebarItemLink_yNGZ sidebarItemLinkActive_oSRm" href="/issues/11">Issue #11</a></li></ul></div><div class="sidebarItemTitle_r4Q1 margin-bottom--md"><a class="sidebarItemLink_yNGZ" href="/issues/archive">Archive</a></div><div><div class="sidebarItemTitle_r4Q1 margin-bottom--md">Feed</div><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a href="/issues/atom.xml" class="sidebarItemLink_yNGZ">Atom</a></li><li class="sidebarItem_lnhn"><a href="/issues/rss.xml" class="sidebarItemLink_yNGZ">RSS</a></li><li class="sidebarItem_lnhn"><a href="/issues/feed.json" class="sidebarItemLink_yNGZ">JSON</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Issue #11</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-07-08T13:10:00.000Z">July 8, 2021</time> · <!-- -->30 min read</div></header><div id="__blog-post-container" class="markdown"><blockquote>
<p>本期关键词：Procella、PrestoDB@Facebook、Apache Arrow、S3 Consistency、Feast、Uptown Records</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="procella-unifying-serving-and-analytical-data-at-youtube">Procella: Unifying serving and analytical data at YouTube<a href="#procella-unifying-serving-and-analytical-data-at-youtube" class="hash-link" aria-label="Direct link to Procella: Unifying serving and analytical data at YouTube" title="Direct link to Procella: Unifying serving and analytical data at YouTube">​</a></h2>
<p><a href="https://research.google/pubs/pub48388" target="_blank" rel="noopener noreferrer">[链接]</a></p>
<p>Procella 是 YouTube 自研的 SQL 查询引擎，旨在用一个引擎满足多种使用场景的需求（有点像<a href="/issues/10">上一期</a>介绍的 Tectonic），目前已经被广泛应用在 YouTube、Google Play、Firebase 等多个产品。论文发表在 2019 年的 VLDB 会议，<a href="/issues/4">第 4 期</a>曾经介绍过同一年发表的 AliGraph。</p>
<p>虽说 Procella 自称 SQL 查询引擎，但其实它也包含一些与存储格式有关的技术，并且这个存储格式对于整体系统来说是不可或缺的一部分，关于这部分后面会单独介绍。先来了解一下 Procella 想要满足的几个场景：</p>
<ul>
<li><strong>分析报告和 dashboard</strong>：YouTube 的创作者（现在应该流行叫 YouTuber）需要通过一个实时更新的 dashboard 来了解所有视频的统计信息，评估内容的影响力。这个场景对响应时间有较高要求（数十毫秒），处理的数据量也非常大（每天有千亿行的新增数据）。</li>
<li><strong>实时统计数据</strong>：这里的统计数据和上一个的区别是上一个还只是面向小部分用户，而这里的统计数据是所有用户在访问 YouTube 时都能看到的（比如点赞数、观看次数），因此请求量会更大，对响应时间的要求也更高。通常 OLAP 系统都是偏离线的，为了应对这种在线查询的场景 Procella 做了很多针对性的优化，后面会详细介绍。</li>
<li><strong>监控系统</strong>：这个场景面向的是内部工程团队，虽然数据量相对较小，但是对数据更新的实时性要求很高。常见的监控系统存储都是用 TSDB 来实现，Procella 因此也需要支持一些 TSDB 独有的特性，如自动降采样（downsampling）和过期旧数据。</li>
<li><strong>Ad-hoc 分析</strong>：这也是面向内部团队的场景，ad-hoc 场景的挑战是查询不可预测，可大可小，可快可慢，系统怎么自适应这些千奇百怪的查询是一个难题。</li>
</ul>
<p>从上面的场景介绍也能看出 Procella 不打算支持或者目前暂时不支持的场景，比如 OLTP、ETL、图计算。</p>
<p>Procella 的主要组件有：Root Server（RS）、Data Server（DS）、Metadata Server（MDS）、Ingestion Server（IgS）、Registration Server（RgS）、Compaction Server（CS）。除此之外还依赖一些外部组件：Metadata Store（Bigtable 和 Spanner）、分布式文件系统（Colossus，<a href="/issues/8">第 8 期</a>曾经介绍过）、容器调度和编排（<a href="https://research.google/pubs/pub43438" target="_blank" rel="noopener noreferrer">Borg</a>）。</p>
<p>RS 是用户提交 SQL 的入口，负责分析、重写、计划和优化执行计划（execution plan）。RS 会和 MDS、Metadata Store 和 DS 直接通信，其中 Metadata Store 保存着表的 schema、表到文件的映射、统计信息、zone map 等元数据，MDS 保存着 zone map、bitmap、bloom filter、分区和排序键等索引信息（这些索引信息一部分在首次注册文件时生成，一部分在查询时生成），DS 负责运行 RS 或者其它 DS 发送的执行计划。不同 DS 之间通信使用 <a href="https://grpc.io/blog/principles" target="_blank" rel="noopener noreferrer">Stubby</a> 这个 RPC 框架（也就是后来开源的 gRPC），同时通过 RDMA 来执行 shuffle 操作（复用了 <a href="https://cloud.google.com/blog/products/bigquery/in-memory-query-execution-in-google-bigquery" target="_blank" rel="noopener noreferrer">BigQuery 的 shuffle 库</a>）。</p>
<p>RgS 负责执行 DDL 命令（如 <code>CREATE</code>、<code>ALTER</code>、 <code>DROP</code>）来管理表，执行结果会保存到 Metadata Store。用户可以在 schema 中指定如列名、数据类型、如何分区和排序、数据接入（data ingestion）方式等信息。Procella 支持两种数据接入方式：批量接入（batch ingestion）和实时接入（realtime ingestion），也就是 <a href="https://en.wikipedia.org/wiki/Lambda_architecture" target="_blank" rel="noopener noreferrer">Lambda 架构</a>，这一点和 <a href="https://druid.apache.org" target="_blank" rel="noopener noreferrer">Druid</a>、<a href="https://pinot.apache.org" target="_blank" rel="noopener noreferrer">Pinot</a> 类似。「批量接入」时由外部批处理任务（如 MapReduce）将数据导入并注册到 RgS，RgS 会从文件头（header）中提取相关信息并建立索引，某些没法直接通过文件头创建的索引（如 bloom filter）会在查询时通过 DS 来创建。「实时接入」时用户通过 RPC 或者 PubSub 的方式把数据导入 IgS，当 IgS 接收到数据以后可能会根据表结构转换数据格式，并写入 WAL 到 Colossus（后台会定期压缩）。IgS 同时还会把数据写入 DS，DS 会在内存中临时缓冲这些数据供用户查询，并定期 checkpoint 到 Colossus 以便在故障时恢复数据。IgS 可能也会将数据写入多个 DS，查询执行时会访问所有副本并使用最完整的集合。</p>
<p>CS 会定期压缩（compact）和重新分区（repartition）IgS 写入的 WAL 日志，转换成对于 DS 来说更高效的更大的分区。在 CS 压缩的过程中，可以执行一些由用户定义的逻辑以减少数据大小，这些逻辑包括过滤、聚合、淘汰旧数据、仅保留最新数据等，通过 SQL 来表示。当处理完以后 CS 会与 RgS 通信更新元数据，从元数据中删除旧文件然后插入新生成的文件。</p>
<p>**为了满足不同场景对于性能的要求，Procella 在多个方面进行了优化，包括：缓存、数据格式、评估引擎（evaluation engine）、分区与索引、分布式操作、查询优化器（optimizer）等。**本期不会对所有优化进行介绍，有兴趣的同学请查看原文。</p>
<p>对于存算分离的引擎，缓存是至关重要的，Procella 也不例外。Procella 包含以下几种类型的缓存：</p>
<ul>
<li><strong>Colossus 元数据缓存</strong>：DS 会缓存 Colossus 的文件句柄，这个句柄包含数据块到 Colossus 服务器的映射关系，可以优化打开文件的性能（减少 1 个或多个 RPC 请求）。</li>
<li><strong>文件头（header）缓存</strong>：Procella 的数据格式（后面会详细介绍）是类似 Parquet 这样的列存格式，因此文件头或者尾会包含很多重要的元信息，DS 会在一个单独的 LRU 缓存中保存这些信息，减少与 Colossus 的交互。</li>
<li><strong>数据缓存</strong>：Procella 的数据格式在内存和磁盘上是同样的结构（可能是能直接通过 mmap 映射到内存），因此数据缓存的管理很轻量。同时 DS 还会缓存一些衍生信息，如某些复杂操作的输出、bloom filter。因为 Colossus 的文件一旦关闭就是不可变的（immutable），所以不存在缓存不一致的问题。</li>
<li><strong>元数据缓存</strong>：Procella 的元数据依赖外部的分布式存储（Bigtable 和 Spanner），虽然元数据很容易进行横向扩展，但外部存储也可能成为系统瓶颈，因此 MDS 通过一个 LRU 缓存保存这些信息。</li>
<li><strong>亲和性（affinity）调度</strong>：当执行查询时，会把操作尽量调度到已经缓存了要处理的数据或者元数据的节点，提高缓存的命中率。这个调度策略不是强制的，有可能会调度到其它节点。</li>
</ul>
<p>综合以上所有类型的缓存，Procella 大体上已经变成了一个全内存数据库。在其中一个分析报告的业务场景，虽然内存只能存放 2% 的数据，但是实际表现是文件句柄的缓存命中率达到了 99%+，数据缓存的命中率达到了 90%，基本不依赖外部系统。</p>
<p>第一版 Procella 的数据格式用的是和 Dremel 一样的 <a href="https://cloud.google.com/blog/products/bigquery/inside-capacitor-bigquerys-next-generation-columnar-storage-format" target="_blank" rel="noopener noreferrer">Capacitor</a>，但由于 Capacitor 的设计主要面向大规模扫描场景，没法支持高效查找（lookup），因此 Procella 设计了一种新的数据格式「Artus」。Artus 主要有以下几个创新点：</p>
<ul>
<li><strong>定制的编码方式</strong>：区别于传统列存格式使用的通用压缩方式（如 LZW），Artus 的编码方式可以在不解压数据块的前提下直接查找单行，进而更加适合小规模的点查和范围扫描场景。</li>
<li><strong>多轮自适应编码</strong>：第一轮先扫描数据收集轻量级的统计信息（如去重以后的数量、最小和最大值），第二轮使用这些统计信息选择最优的编码方式。这里「最优」的判断逻辑是基于各种编码方式提供的预估方法（estimation method），这个预估方法能给出处理对应数据的时间和空间，然后根据用户设定的目标函数（objective function）来自动选择。</li>
<li><strong>选择支持二分查找的编码方式</strong>：对于有序的列，查找所需的时间复杂度是 O(logN)。同时在列数据中查找某一行的时间复杂度可以做到 O(1)，因此查找 K 列的时间复杂度是 O(logN + K)。O(1) 是最优的时间复杂度，对于如 RLE（Run-Length Encoding）这样的编码需要每 B 行额外维护一些「跳块」（skip block）信息，实际的时间复杂度其实是 O(B)，但 B 的取值通常很小（如 32、128）。</li>
<li><strong>用一种创新性的方式表示嵌套和重复数据类型</strong>：对于查找嵌套（nested）和重复（repeated）数据类型的数据可以做到 O(1) 的时间复杂度。</li>
<li><strong>把字典索引、RLE 以及其它编码信息直接暴露给评估引擎</strong>：可以把过滤逻辑下推到数据格式，多数场景下都能有不错的性能提升。</li>
<li><strong>在文件头和列头记录丰富的元数据</strong>：这些元数据包括排序信息、最小和最大值、编码信息、bloom filter 等，可以在不读取实际数据的情况下实现剪枝（pruning）操作。</li>
<li><strong>支持存储倒排索引</strong>：Procella 主要在 A/B 实验分析场景用到倒排索引，这些倒排索引存储为 <a href="https://www.roaringbitmap.org" target="_blank" rel="noopener noreferrer">Roaring bitmaps</a> 格式。Roaring bitmaps 已经被广泛应用于各种大数据引擎，包括 Spark、Druid、Kylin、Doris、ClickHouse 等。</li>
</ul>
<p>在 YouTube Analytics 数据集的实际测试中，Artus 相比 Capacitor 最多能有 140 倍的性能提升，平均也有 50 倍的性能差距。</p>
<p>高性能的评估引擎（evaluation engine）对于低延时请求来说是至关重要的，很多现代分析系统会在查询时通过 LLVM 将执行计划编译为原生代码，以此来加速查询。但是 Procella 因为还要处理高 QPS 的在线服务场景，编译的耗时会成为这个场景的性能瓶颈。因此 Procella 研发了自己的评估引擎「Superluminal（超光速）」，它主要有以下几个特点：</p>
<ul>
<li>广泛使用 C++ 的模板元编程（template metaprogramming）特性在编译时生成代码</li>
<li>以块（block）为单位处理数据，更好地利用向量化（vectorized）计算以及缓存感知（cache-aware）算法。每个块的大小会根据 L1 缓存的大小进行预估。</li>
<li>直接原生操作底层数据编码，并在函数应用期间尽可能保留它。编码信息或者是从文件格式中获取，或者是在执行时生成。</li>
<li>以列式存储的方式处理结构化数据，不会物化（materialized）中间结果。</li>
<li>动态合并过滤器以及下推执行计划，使得每个节点仅仅扫描确切需要的数据。</li>
</ul>
<p>前面提到 Procella 一个重要使用场景就是「实时统计数据」，通常意义上的 OLAP 系统都不太能应对这类实时场景的要求（不管是延时还是 QPS），所以一般会选用 OLTP 或者缓存系统（如 Redis）来解决。这类场景的查询非常简单：<code>SELECT SUM(views) FROM Table WHERE video id = N</code>，数据规模也不大（最多 10 亿级行），但是每个 Procella 实例需要在承载百万级 QPS 的同时实现毫秒级响应，数据也需要能够做到近实时更新，因此 Procella 专门设计了一个「stats serving」模式，这个模式包含以下一些优化：</p>
<ul>
<li>当新数据注册进来时，RgS 会通知 DS（主从 DS 都包括）新数据已经准备好了，然后 DS 就会立即将数据加载到内存中。这个优化是为了保证执行查询时不会访问远端存储，虽然会耗费一些内存但是按照业务的数据量这是可接受的。</li>
<li>MDS 被作为一个模块编译进 RS，尽可能减少 RPC 通信。</li>
<li>所有元数据都会异步加载进内存，和数据一样确保不会产生远端访问。</li>
<li>激进地缓存查询计划，降低分析和计划查询的开销。</li>
<li>RS 会将相同 key 的请求批量发送给 DS，减少 RPC 通信。</li>
<li>RS 和 DS 会监控每个任务的错误率和响应时间，如果发现异常高的任务会自动转移到其它机器。做这个优化一部分也是因为 Borg 的资源隔离做得不够好。</li>
<li>关闭复杂的优化和操作（如自适应 join 和 shuffle），避免不必要的开销以及生产环境的风险。</li>
</ul>
<p>最后是一些生产环境的实际数据。在 YouTube Analytics（YTA）业务中，一共有 5 组 Procella 集群，其中至少有 3 个在服务线上请求，每组集群有大约 6000 个核以及 20TB 的内存。YTA 业务每天有超过数十亿的请求，涉及数十 PB 的数据。YTA E2E 的响应时间 P50、P99、P99.9 分别是 25、412、2859 毫秒。「实时统计数据」业务每天有上千亿的请求，响应时间 P50、P99、P99.99 分别是 1.6、3.3、21.7 毫秒。</p>
<p>以上就是 Procella 的全部介绍，熟悉 Google 的同学可能关心为什么 YouTube 团队不直接用 Google 现有的一些基础设施呢。论文中也对相关系统做了简单介绍和比较，其中：</p>
<ul>
<li><a href="https://research.google/pubs/pub36632" target="_blank" rel="noopener noreferrer">Dremel</a>（VLDB 2010）是一个为 ad-hoc 场景优化的列式 SQL 查询引擎，支持多种后端（如 ColumnIO、Capacitor、Bigtable），同时 Dremel 也是 Google Cloud BigQuery 的底层引擎。Procella 与 Dremel 有诸多相似之处，如 RPC 协议、SQL 分析器、底层存储（Colossus）、容器编排（Borg）。但也有很多不一样的地方，如大量使用缓存（Dremel 基本是无状态的）、为不同业务场景部署不同的集群（Dremel 是一个多租系统）、可索引的数据格式（Capacitor 不可索引）。Dremel 影响了后续很多大数据开源项目，如 Parquet（Parquet 最初叫做 <a href="https://github.com/julienledem/redelm" target="_blank" rel="noopener noreferrer">RedElm</a>，是由 Dremel 的字母重新排列组成）。</li>
<li><a href="https://research.google/pubs/pub40465" target="_blank" rel="noopener noreferrer">PowerDrill</a>（VLDB 2012）是一个全内存列式分布式 SQL 查询引擎。PowerDrill 适合小 QPS 以及简单查询的场景，主要应用在日志数据分析以及内部 dashboard。</li>
<li><a href="https://research.google/pubs/pub41344" target="_blank" rel="noopener noreferrer">F1</a>（VLDB 2013）是一个分布式查询引擎，支持多种后端（如 ColumnIO、Capacitor、Bigtable、Spanner、Mesa）。F1 和 Procella 最大的不同是，因为 F1 本身只是一个查询引擎，用户需要根据场景选用合适的后端存储，如 OLTP 场景选 Spanner、ad-hoc 分析场景选 Capacitor 等。但是 Procella 用一套系统同时满足了多种场景的需求，计算和数据格式也是强绑定的。</li>
<li><a href="https://research.google/pubs/pub42851" target="_blank" rel="noopener noreferrer">Mesa</a>（VLDB 2014）是一个集存储和查询一体的数据系统。Mesa 最初是为了满足 Google 广告业务的需求而设计，因此在设计上有很多独特的地方，如预聚合数据、基于 delta 的数据接入（更新时效在分钟级）。Mesa 并不支持 SQL 查询，而是通过 F1 来实现。百度开源的 <a href="http://doris.incubator.apache.org" target="_blank" rel="noopener noreferrer">Doris</a> 即是基于 Mesa 来设计（一个题外话，Doris 的 SQL 查询是基于 Impala 实现）。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="presto-at-facebook-state-of-the-union">Presto at Facebook: State of the Union<a href="#presto-at-facebook-state-of-the-union" class="hash-link" aria-label="Direct link to Presto at Facebook: State of the Union" title="Direct link to Presto at Facebook: State of the Union">​</a></h2>
<p><a href="https://www.youtube.com/watch?v=JuWiWmUtn3M" target="_blank" rel="noopener noreferrer">[链接]</a></p>
<p>今年 3 月 24 日 PrestoDB 举办了 PrestoCon Day（<a href="/issues/6">第 6 期</a>曾经介绍过「Presto: SQL on Everything」这篇论文），这个视频来自前面 Procella 论文的第一作者 Biswapesh Chattopadhyay，从他的 <a href="https://www.linkedin.com/in/biswapesh" target="_blank" rel="noopener noreferrer">LinkedIn</a> 上看他于 2019 年从 Google 离职并加入了 Facebook，领导整个大数据基础设施团队。Biswapesh 首先总结了 PrestoDB 目前为止的一些进展，如 Disaggregated coordinator、CBO、RaptorX、Velox（原生代码加速器，有点类似 Procella 的 Superluminal）、CoreSQL。这些特性有些已经在 Facebook 生产环境稳定运行，有些还在灰度测试，有些还处于早期设计阶段。未来规划中列举了一些 PrestoDB 的目标，如支持更多类型的 SQL（HQL 等）、更多运行模式（流式、批处理、交互式查询、图计算）、更多元数据存储（Hive Metastore、Iceberg、Delta Lake）、更多格式（ORC、Parquet）。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="origin-and-history-of-apache-arrow">Origin and History of Apache Arrow<a href="#origin-and-history-of-apache-arrow" class="hash-link" aria-label="Direct link to Origin and History of Apache Arrow" title="Direct link to Origin and History of Apache Arrow">​</a></h2>
<p><a href="https://www.dremio.com/origin-history-of-apache-arrow" target="_blank" rel="noopener noreferrer">[链接]</a></p>
<p>2016 年 2 月 Cloudera 公开<a href="https://blog.cloudera.com/introducing-apache-arrow-a-fast-interoperable-in-memory-columnar-data-structure-standard" target="_blank" rel="noopener noreferrer">宣布</a>了 Apache Arrow 项目（以下简称 Arrow），距今这个项目已经发展了 5 年时间。Arrow 最初由 <a href="https://pandas.pydata.org" target="_blank" rel="noopener noreferrer">Pandas</a> 和 <a href="https://ibis-project.org" target="_blank" rel="noopener noreferrer">Ibis</a> 项目的作者 Wes McKinney 在 2014 年发起，当时他还在 Cloudera 工作，项目名也还不叫做 Arrow。2015 年 Wes 和 Jacques Nadeau 及 <a href="https://drill.apache.org" target="_blank" rel="noopener noreferrer">Apache Drill</a> 团队有了一些接触，Jacques 等人对于这个项目表示了浓厚的兴趣。这里稍微扯远一些，Apache Drill 是由 Tomer Shiran 在 MapR 工作时发起，很大程度上是受 Google Dremel 启发和影响，2015 年那会儿 Tomer 和 Jacques 正在准备创立 <a href="https://www.dremio.com" target="_blank" rel="noopener noreferrer">Dremio</a>（Tomer 是 CEO，Jacques 是 CTO）。后来经过早期参与者<a href="https://docs.google.com/spreadsheets/d/1q6UqluW6SLuMKRwW2TBGBzHfYLlXYm37eKJlIxWQGQM" target="_blank" rel="noopener noreferrer">投票</a>，正式确定了使用 Arrow 作为项目名（因为向量的数学符号是箭头）。这里提到向量，是因为 Arrow 是受现在很火的向量化（vectorization）影响。提到向量化往往还会讲到列式存储，我们熟知的列式存储格式如 Parquet 已经定义了数据如何在磁盘上组织，但是当把这些数据从磁盘中读取出来处理时，它们在内存以及 CPU 中应该以何种格式存在呢？是继续以列式格式处理还是转成行式呢？目前大部分计算引擎其实还是以行式进行处理，但是向量化证明了以列式进行处理在 OLAP 场景是更加高效的。**因此 Arrow 的目标是制定一种语言无关的内存中的列式存储格式，并以库的形式集成到各种计算引擎中，避免重复造轮子。**理想情况下，数据从磁盘 → 内存 → CPU 不需要经过任何格式转换和拷贝，最大化处理效率。Arrow 官方目前已经支持 12 种编程语言，如果想拓展到新语言，可以很方便地在 C++ 实现之上扩展。现在 Arrow 已经不仅仅是一种存储格式，还包括 RPC 框架（<a href="https://arrow.apache.org/blog/2019/10/13/introducing-arrow-flight" target="_blank" rel="noopener noreferrer">Flight</a>）、高性能执行内核（<a href="https://www.dremio.com/announcing-gandiva-initiative-for-apache-arrow" target="_blank" rel="noopener noreferrer">Gandiva</a>）、查询引擎（<a href="https://arrow.apache.org/blog/2019/02/04/datafusion-donation" target="_blank" rel="noopener noreferrer">DataFusion</a>）等组件，逐渐丰富 Arrow 的生态。有了这些基础组件，使得实现一个新的 OLAP 系统的门槛大大降低，也难怪 InfluxDB 创始人 Paul Dix 要<a href="https://www.influxdata.com/blog/apache-arrow-parquet-flight-and-their-ecosystem-are-a-game-changer-for-olap" target="_blank" rel="noopener noreferrer">大肆鼓吹</a>。Arrow 是一个非常有野心的项目，值得长期关注。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="diving-deep-on-s3-consistency">Diving Deep on S3 Consistency<a href="#diving-deep-on-s3-consistency" class="hash-link" aria-label="Direct link to Diving Deep on S3 Consistency" title="Direct link to Diving Deep on S3 Consistency">​</a></h2>
<p><a href="https://www.allthingsdistributed.com/2021/04/s3-strong-consistency.html" target="_blank" rel="noopener noreferrer">[链接]</a></p>
<p>去年 12 月 1 日，AWS <a href="https://aws.amazon.com/blogs/aws/amazon-s3-update-strong-read-after-write-consistency" target="_blank" rel="noopener noreferrer">宣布</a>在 S3 发布 14 年后终于支持强一致性。作为对象存储的创造者，S3 一直是这个领域的标杆，基本就是对象存储的代名词（一个不太一样的地方是，国内通常用 OSS 来指代对象存储）。但对象存储的「最终一致性」一直被人所<a href="https://databricks.com/session_na20/from-hdfs-to-s3-migrate-pinterest-apache-spark-clusters" target="_blank" rel="noopener noreferrer">诟病</a>，特别是随着越来越多业务场景依赖对象存储（比如大数据），这是 S3 诞生时完全预料不到的。而 AWS 的竞争者们虽然是后来者，但已经纷纷支持强一致性，比如 <a href="https://cloud.google.com/blog/products/gcp/how-google-cloud-storage-offers-strongly-consistent-object-listing-thanks-to-spanner" target="_blank" rel="noopener noreferrer">Google Cloud Storage</a>、<a href="https://sigops.org/sosp/sosp11/current/2011-Cascais/printable/11-calder.pdf" target="_blank" rel="noopener noreferrer">Azure Storage</a>。Amazon 的 CTO Werner Vogels 近期发布的这篇博客披露了更多有关 S3 如何实现强一致性的细节，以 S3 目前的体量增加新特性必须做到小心翼翼，不能对现有系统造成任何影响。具体的，S3 在元数据子系统中新增了一个叫做 <a href="http://www2.cs.uh.edu/~paris/MYPAPERS/Icdcs86.pdf" target="_blank" rel="noopener noreferrer">Witness</a> 的组件通过事件通知的机制来确保缓存的一致性，这样既实现了强一致性的目标，也确保了 S3 整体的稳定性没有受到影响。有趣的是这篇博客的评论中有人也对这个设计提出了一些质疑，怀疑 S3 是否真的能做到强一致性，毕竟这次改进并没有改变 S3 系统的核心设计。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-state-of-feast">A State of Feast<a href="#a-state-of-feast" class="hash-link" aria-label="Direct link to A State of Feast" title="Direct link to A State of Feast">​</a></h2>
<p><a href="https://feast.dev/blog/a-state-of-feast" target="_blank" rel="noopener noreferrer">[链接]</a></p>
<p>Feast 项目由 Willem Pienaar 在 Gojek（一家面向东南亚市场的「啥都做」公司）工作时发起，并和 Google Cloud 合作，在 2019 年联合发表了一篇<a href="https://cloud.google.com/blog/products/ai-machine-learning/introducing-feast-an-open-source-feature-store-for-machine-learning" target="_blank" rel="noopener noreferrer">介绍文章</a>。Feast 的定位很好理解，就是做开源的特征存储框架，叫存储系统可能不太合适，毕竟实际的数据存储还是要依靠外部系统，Feast 专注在如何统一管理和使用特征。说到特征管理，有过相关经验的同学一定知道「训练/服务偏斜」（Training-Serving Skew），这一点在著名的「Rules of Machine Learning」中也有<a href="https://developers.google.com/machine-learning/guides/rules-of-ml#training-serving_skew" target="_blank" rel="noopener noreferrer">提到</a>。数据科学家可能有 <a href="https://www.forbes.com/sites/gilpress/2016/03/23/data-preparation-most-time-consuming-least-enjoyable-data-science-task-survey-says" target="_blank" rel="noopener noreferrer">80% 的时间</a>都在清洗和准备数据，特征工程（feature engineering）对于模型质量也至关重要。大公司可能都会自己造各种轮子来管理特征，比如 Uber 的 <a href="https://eng.uber.com/michelangelo-machine-learning-platform" target="_blank" rel="noopener noreferrer">Michelangelo</a>，现在 Uber 的这几位也出来创业，成立了一家叫做 <a href="https://www.tecton.ai" target="_blank" rel="noopener noreferrer">Tecton</a> 的公司。Feast 的作者 Willem Pienaar 也<a href="https://www.tecton.ai/blog/feast-announcement" target="_blank" rel="noopener noreferrer">加入</a>了 Tecton，不过他还会继续负责 Feast 开源社区。未来 Feast 会朝着更易用、更模块化、更云厂商中立的定位去发展，同时补足与 Tecton 闭源版本之间的一些功能差异。如果你对什么是特征存储感兴趣，也推荐阅读<a href="https://www.tecton.ai/blog/what-is-a-feature-store" target="_blank" rel="noopener noreferrer">这篇文章</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="uptown-records-十年不只是一家唱片店">Uptown Records 十年，不只是一家唱片店<a href="#uptown-records-十年不只是一家唱片店" class="hash-link" aria-label="Direct link to Uptown Records 十年，不只是一家唱片店" title="Direct link to Uptown Records 十年，不只是一家唱片店">​</a></h2>
<p><a href="https://mp.weixin.qq.com/s/0A9WqPBGl462QOSn-e30Xw" target="_blank" rel="noopener noreferrer">[链接]</a></p>
<p>Uptown 是一家位于上海以黑胶为主的独立唱片店，如果你曾经在上海生活过并且喜爱音乐一定听说过它。Uptown 的诞生得追溯到 2011 年，在平武路和幸福路交叉口的一间地下室，原本想要做成一间酒吧，后来阴差阳错地变成了一家独立唱片店，老板 Sacco 和老板娘 Sophia 就这样一直经营到了现在。大概 5、6 年前我初到上海时，就和叶子一起慕名前往了这间没有任何招牌的地下室，走下阴暗的楼梯，然后穿过长长的狭窄的昏暗过道，尽头的一间小房子就是 Uptown。店里当时只有一名员工，屋里放着音乐，顾客只有我们两个，基本把店里陈列的唱片都翻了一遍，印象比较深的是看到了几张 Carsick Cars 的唱片，大部分还是国外的我不认识的艺术家。后来听说 Uptown 开了分店，在永福路，也终于不是在地下，但一直没有造访。2019 年因为要给一个<a href="/issues/5">好朋友</a>送礼物特地去了一次永福路的 Uptown，虽说在地上但招牌依然不明显，黑色招牌上只有 RnB（Records &amp; Beer）这几个字，不仔细留意的话很容易错过。这次买了两张唱片，一张是 New Order 的《Movement》，一张是 JAMC 的《Automatic》，成色都还不错。这篇文章来自「BIE 别的」公众号，介绍了很多 Uptown 早期不为人知的故事，比如上海胶圈另一个著名的组织 Daily Vinyl 的联合创始人曾经也是 Uptown 的员工。现在平武路的这间地下室租约到期，因为无法承担涨价以后的房租，Uptown 不得不发起了「Save Uptown」的筹款活动，试图保住这个对于城市音乐场景有着重大意义的地方。从<a href="http://www.dianping.com/shop/H1OY8mlbOWjK5hJ7" target="_blank" rel="noopener noreferrer">大众点评</a>的信息看，平武路的 Uptown 最终还是没能延续，就像几年前的另一家上海音乐地标 Shelter 一样（类似的故事还有很多）。每个城市都有属于这个城市的「角落」，正是这些角落的存在慰藉着形形色色的人们。</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/issues/tags/issue">issue</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/issues/12"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Issue #12</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/issues/10"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Issue #10</div></a></nav><div class="commentContainer_NL3Q"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#procella-unifying-serving-and-analytical-data-at-youtube" class="table-of-contents__link toc-highlight">Procella: Unifying serving and analytical data at YouTube</a></li><li><a href="#presto-at-facebook-state-of-the-union" class="table-of-contents__link toc-highlight">Presto at Facebook: State of the Union</a></li><li><a href="#origin-and-history-of-apache-arrow" class="table-of-contents__link toc-highlight">Origin and History of Apache Arrow</a></li><li><a href="#diving-deep-on-s3-consistency" class="table-of-contents__link toc-highlight">Diving Deep on S3 Consistency</a></li><li><a href="#a-state-of-feast" class="table-of-contents__link toc-highlight">A State of Feast</a></li><li><a href="#uptown-records-十年不只是一家唱片店" class="table-of-contents__link toc-highlight">Uptown Records 十年，不只是一家唱片店</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Maybe News. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>